<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketé€šçŸ¥æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background-color: #4CAF50;
            color: white;
        }
        .status.disconnected {
            background-color: #f44336;
            color: white;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .disconnect-btn {
            background-color: #f44336;
        }
        .disconnect-btn:hover {
            background-color: #da190b;
        }
        .notifications {
            margin-top: 20px;
        }
        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .notification.HIGH {
            background-color: #ffebee;
            border-color: #f44336;
        }
        .notification.MEDIUM {
            background-color: #fff3e0;
            border-color: #ff9800;
        }
        .notification.LOW {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        .notification.INFO {
            background-color: #f1f8e9;
            border-color: #8bc34a;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .notification-title {
            font-weight: bold;
            font-size: 16px;
        }
        .notification-severity {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .notification-severity.HIGH {
            background-color: #f44336;
            color: white;
        }
        .notification-severity.MEDIUM {
            background-color: #ff9800;
            color: white;
        }
        .notification-severity.LOW {
            background-color: #2196F3;
            color: white;
        }
        .notification-severity.INFO {
            background-color: #8bc34a;
            color: white;
        }
        .notification-message {
            margin: 8px 0;
            color: #555;
        }
        .notification-meta {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }
        .notification-data {
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .clear-btn {
            background-color: #9e9e9e;
        }
        .clear-btn:hover {
            background-color: #757575;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”” WebSocketé€šçŸ¥æµ‹è¯•å®¢æˆ·ç«¯</h1>
        
        <div id="status" class="status disconnected">
            æœªè¿æ¥
        </div>

        <div class="controls">
            <input type="text" id="wsUrl" value="ws://localhost:8080/api/v1/ws" placeholder="WebSocket URL">
            <button id="connectBtn" onclick="connect()">è¿æ¥</button>
            <button id="disconnectBtn" class="disconnect-btn" onclick="disconnect()" disabled>æ–­å¼€</button>
            <button class="clear-btn" onclick="clearNotifications()">æ¸…ç©ºé€šçŸ¥</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalNotifications">0</div>
                <div class="stat-label">æ€»é€šçŸ¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="connectionTime">--</div>
                <div class="stat-label">è¿æ¥æ—¶é•¿</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lastPing">--</div>
                <div class="stat-label">æœ€åå¿ƒè·³</div>
            </div>
        </div>

        <div class="notifications">
            <h2>é€šçŸ¥åˆ—è¡¨</h2>
            <div id="notificationList"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let connectionId = null;
        let notificationCount = 0;
        let connectionStartTime = null;
        let connectionTimeInterval = null;

        function connect() {
            const url = document.getElementById('wsUrl').value;
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    updateStatus('connected', 'å·²è¿æ¥');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    connectionStartTime = Date.now();
                    startConnectionTimer();
                    addLog('WebSocketè¿æ¥å·²å»ºç«‹');
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };

                ws.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    addLog('WebSocketé”™è¯¯: ' + error.message, 'error');
                };

                ws.onclose = () => {
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    stopConnectionTimer();
                    addLog('WebSocketè¿æ¥å·²å…³é—­');
                };
            } catch (error) {
                alert('è¿æ¥å¤±è´¥: ' + error.message);
            }
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleMessage(message) {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

            switch (message.type) {
                case 'connected':
                    connectionId = message.connection_id;
                    addLog(`è¿æ¥ID: ${connectionId}`);
                    break;

                case 'ping':
                    // å“åº”å¿ƒè·³
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'pong' }));
                    }
                    updateLastPing();
                    addLog('æ”¶åˆ°å¿ƒè·³ï¼Œå·²å“åº”');
                    break;

                case 'security_alert':
                case 'threat_alert':
                case 'key_warning':
                case 'device_status_change':
                case 'system_alert':
                    addNotification(message);
                    break;

                default:
                    addLog('æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + message.type);
            }
        }

        function addNotification(notification) {
            notificationCount++;
            document.getElementById('totalNotifications').textContent = notificationCount;

            const notificationList = document.getElementById('notificationList');
            const notificationEl = document.createElement('div');
            notificationEl.className = `notification ${notification.severity}`;
            
            const typeMap = {
                'security_alert': 'ğŸ”’ å®‰å…¨å‘Šè­¦',
                'threat_alert': 'âš ï¸ å¨èƒå‘Šè­¦',
                'key_warning': 'ğŸ”‘ å¯†é’¥é¢„è­¦',
                'device_status_change': 'ğŸ“± è®¾å¤‡çŠ¶æ€å˜æ›´',
                'system_alert': 'ğŸ–¥ï¸ ç³»ç»Ÿå‘Šè­¦'
            };

            notificationEl.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${typeMap[notification.type] || notification.title}</div>
                    <div class="notification-severity ${notification.severity}">${notification.severity}</div>
                </div>
                <div class="notification-message">${notification.message}</div>
                <div class="notification-meta">
                    ${notification.device_id ? `è®¾å¤‡: ${notification.device_id} | ` : ''}
                    ${notification.threat_id ? `å¨èƒID: ${notification.threat_id} | ` : ''}
                    æ—¶é—´: ${new Date(notification.timestamp).toLocaleString('zh-CN')}
                </div>
                ${notification.data ? `<div class="notification-data">${JSON.stringify(notification.data, null, 2)}</div>` : ''}
            `;

            notificationList.insertBefore(notificationEl, notificationList.firstChild);
        }

        function addLog(message, type = 'info') {
            console.log(`[${type}] ${message}`);
        }

        function updateStatus(status, text) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${status}`;
            statusEl.textContent = text;
        }

        function updateLastPing() {
            document.getElementById('lastPing').textContent = new Date().toLocaleTimeString('zh-CN');
        }

        function startConnectionTimer() {
            connectionTimeInterval = setInterval(() => {
                if (connectionStartTime) {
                    const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('connectionTime').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopConnectionTimer() {
            if (connectionTimeInterval) {
                clearInterval(connectionTimeInterval);
                connectionTimeInterval = null;
            }
            document.getElementById('connectionTime').textContent = '--';
        }

        function clearNotifications() {
            document.getElementById('notificationList').innerHTML = '';
            notificationCount = 0;
            document.getElementById('totalNotifications').textContent = '0';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            // å¯ä»¥å–æ¶ˆæ³¨é‡Šä»¥è‡ªåŠ¨è¿æ¥
            // connect();
        });

        // é¡µé¢å¸è½½æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
