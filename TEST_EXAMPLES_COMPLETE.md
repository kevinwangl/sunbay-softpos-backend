# æµ‹è¯•ç¤ºä¾‹æ–‡ä»¶åˆ›å»ºå®Œæˆ

## æ¦‚è¿°

å·²ä¸º SunBay SoftPOS åç«¯é¡¹ç›®åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•ç¤ºä¾‹æ–‡ä»¶ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œæµ‹è¯•å·¥å…·ã€‚

## åˆ›å»ºçš„æ–‡ä»¶

### 1. å•å…ƒæµ‹è¯• (Unit Tests)

#### `tests/unit/models/device_test.rs`
è®¾å¤‡æ¨¡å‹çš„å•å…ƒæµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… è®¾å¤‡åˆ›å»ºæµ‹è¯•
- âœ… è®¾å¤‡çŠ¶æ€è½¬æ¢æµ‹è¯•
- âœ… å®‰å…¨è¯„åˆ†éªŒè¯æµ‹è¯•
- âœ… è®¾å¤‡IDæ ¼å¼éªŒè¯æµ‹è¯•

**æµ‹è¯•è¦†ç›–**ï¼š
- åŸºæœ¬CRUDæ“ä½œ
- æ•°æ®éªŒè¯é€»è¾‘
- è¾¹ç•Œæ¡ä»¶å¤„ç†

#### `tests/unit/security/dukpt_test.rs`
DUKPTåŠ å¯†çš„å•å…ƒæµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å¯†é’¥æ´¾ç”Ÿæµ‹è¯•
- âœ… åŠ å¯†/è§£å¯†å¾€è¿”æµ‹è¯•
- âœ… KSNè®¡æ•°å™¨é€’å¢æµ‹è¯•
- âœ… æ— æ•ˆKSNé•¿åº¦å¤„ç†
- âœ… PINå—æ ¼å¼åŒ–æµ‹è¯•
- âœ… å¤šäº¤æ˜“ä¸åŒå¯†é’¥æµ‹è¯•

**æµ‹è¯•è¦†ç›–**ï¼š
- åŠ å¯†ç®—æ³•æ­£ç¡®æ€§
- å¯†é’¥ç®¡ç†
- é”™è¯¯å¤„ç†

### 2. é›†æˆæµ‹è¯• (Integration Tests)

#### `tests/integration/api/device_api_test.rs`
è®¾å¤‡APIç«¯ç‚¹çš„é›†æˆæµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… è®¾å¤‡æ³¨å†ŒæˆåŠŸæµ‹è¯•
- âœ… é‡å¤è®¾å¤‡æ³¨å†Œæµ‹è¯•
- âœ… æ ¹æ®IDè·å–è®¾å¤‡æµ‹è¯•
- âœ… è®¾å¤‡æœªæ‰¾åˆ°æµ‹è¯•
- âœ… åˆ†é¡µåˆ—è¡¨æµ‹è¯•
- âœ… è®¾å¤‡å®¡æ‰¹æµ‹è¯•
- âœ… æŒ‰çŠ¶æ€è¿‡æ»¤æµ‹è¯•

**æµ‹è¯•è¦†ç›–**ï¼š
- HTTPç«¯ç‚¹åŠŸèƒ½
- è¯·æ±‚/å“åº”å¤„ç†
- é”™è¯¯çŠ¶æ€ç 
- åˆ†é¡µå’Œè¿‡æ»¤

#### `tests/integration/services/transaction_service_test.rs`
äº¤æ˜“æœåŠ¡çš„é›†æˆæµ‹è¯•ï¼ŒåŒ…æ‹¬ï¼š
- âœ… åˆ›å»ºäº¤æ˜“æˆåŠŸæµ‹è¯•
- âœ… äº¤æ˜“å¤„ç†æµç¨‹æµ‹è¯•
- âœ… æ— æ•ˆè®¾å¤‡äº¤æ˜“æµ‹è¯•
- âœ… äº¤æ˜“å†å²æŸ¥è¯¢æµ‹è¯•
- âœ… äº¤æ˜“é‡‘é¢éªŒè¯æµ‹è¯•
- âœ… é€€æ¬¾äº¤æ˜“æµ‹è¯•
- âœ… äº¤æ˜“ç»Ÿè®¡æµ‹è¯•
- âœ… å¹¶å‘äº¤æ˜“æµ‹è¯•

**æµ‹è¯•è¦†ç›–**ï¼š
- ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§
- æ•°æ®åº“äº¤äº’
- å¹¶å‘å¤„ç†
- é”™è¯¯åœºæ™¯

### 3. æµ‹è¯•åŸºç¡€è®¾æ–½

#### `tests/lib.rs`
æµ‹è¯•åº“æ ¹æ–‡ä»¶ï¼Œæä¾›ï¼š
- æ¨¡å—ç»„ç»‡
- ä¸»crateæ¨¡å—é‡å¯¼å‡º

#### `tests/unit/mod.rs` & `tests/integration/mod.rs`
æµ‹è¯•æ¨¡å—ç»„ç»‡æ–‡ä»¶

#### `tests/README.md`
å®Œæ•´çš„æµ‹è¯•æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- ğŸ“– æµ‹è¯•ç»“æ„è¯´æ˜
- ğŸš€ è¿è¡Œæµ‹è¯•å‘½ä»¤
- ğŸ—„ï¸ æµ‹è¯•æ•°æ®åº“è®¾ç½®
- ğŸ“ æµ‹è¯•ç¼–å†™æ¨¡æ¿
- ğŸ“Š æµ‹è¯•è¦†ç›–ç‡ç”Ÿæˆ
- ğŸ”§ æ•…éšœæ’é™¤æŒ‡å—

#### `run-tests.sh`
è‡ªåŠ¨åŒ–æµ‹è¯•è¿è¡Œè„šæœ¬ï¼Œæ”¯æŒï¼š
- âœ… è‡ªåŠ¨æ£€æŸ¥PostgreSQLçŠ¶æ€
- âœ… è‡ªåŠ¨åˆ›å»ºæµ‹è¯•æ•°æ®åº“
- âœ… è‡ªåŠ¨è¿è¡Œè¿ç§»
- âœ… å¤šç§æµ‹è¯•æ¨¡å¼ï¼ˆunit/integration/all/coverage/watchï¼‰
- âœ… å½©è‰²è¾“å‡ºå’Œé”™è¯¯æç¤º

#### `.cargo/config.toml`
Cargoæµ‹è¯•é…ç½®ï¼ŒåŒ…æ‹¬ï¼š
- æµ‹è¯•ç¯å¢ƒå˜é‡
- æµ‹è¯•æ€§èƒ½ä¼˜åŒ–

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./run-tests.sh

# æˆ–ä½¿ç”¨ cargo
cargo test
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•

```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
./run-tests.sh unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
./run-tests.sh integration

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
./run-tests.sh coverage

# ç›‘è§†æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡æ–°è¿è¡Œï¼‰
./run-tests.sh watch

# æ¸…ç†æµ‹è¯•æ•°æ®åº“
./run-tests.sh clean
```

### è¿è¡Œç‰¹å®šæµ‹è¯•

```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
cargo test device_test

# è¿è¡Œç‰¹å®šæµ‹è¯•å‡½æ•°
cargo test test_device_creation

# æ˜¾ç¤ºæµ‹è¯•è¾“å‡º
cargo test -- --nocapture

# å•çº¿ç¨‹è¿è¡Œï¼ˆä¾¿äºè°ƒè¯•ï¼‰
cargo test -- --test-threads=1
```

## æµ‹è¯•æ•°æ®åº“è®¾ç½®

### è‡ªåŠ¨è®¾ç½®ï¼ˆæ¨èï¼‰
```bash
./run-tests.sh
```
è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®åº“è®¾ç½®ã€‚

### æ‰‹åŠ¨è®¾ç½®
```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“
createdb softpos_test

# 2. è¿è¡Œè¿ç§»
DATABASE_URL=postgres://postgres:postgres@localhost/softpos_test sqlx migrate run

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
export TEST_DATABASE_URL=postgres://postgres:postgres@localhost/softpos_test

# 4. è¿è¡Œæµ‹è¯•
cargo test
```

## æµ‹è¯•è¦†ç›–ç‡

ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Šï¼š

```bash
# ä½¿ç”¨è„šæœ¬
./run-tests.sh coverage

# æˆ–ç›´æ¥ä½¿ç”¨ tarpaulin
cargo tarpaulin --out Html --output-dir coverage

# æŸ¥çœ‹æŠ¥å‘Š
open coverage/index.html
```

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•å‘½å
```rust
// æ ¼å¼: test_<åŠŸèƒ½>_<åœºæ™¯>_<é¢„æœŸç»“æœ>
#[test]
fn test_device_registration_with_valid_data_succeeds() { }

#[test]
fn test_device_registration_with_duplicate_id_fails() { }
```

### 2. AAAæ¨¡å¼
```rust
#[test]
fn test_example() {
    // Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®
    let input = "test";
    
    // Act - æ‰§è¡Œè¢«æµ‹è¯•çš„åŠŸèƒ½
    let result = function_under_test(input);
    
    // Assert - éªŒè¯ç»“æœ
    assert_eq!(result, expected);
}
```

### 3. æµ‹è¯•éš”ç¦»
- æ¯ä¸ªæµ‹è¯•åº”è¯¥ç‹¬ç«‹è¿è¡Œ
- ä½¿ç”¨äº‹åŠ¡æˆ–æ¸…ç†å‡½æ•°
- é¿å…æµ‹è¯•é—´çš„ä¾èµ–

### 4. è¾¹ç•Œæµ‹è¯•
```rust
#[test]
fn test_boundary_conditions() {
    assert!(validate_score(0));    // æœ€å°å€¼
    assert!(validate_score(100));  // æœ€å¤§å€¼
    assert!(!validate_score(-1));  // ä½äºæœ€å°å€¼
    assert!(!validate_score(101)); // é«˜äºæœ€å¤§å€¼
}
```

## æŒç»­é›†æˆ

æµ‹è¯•ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è¿è¡Œï¼š
- âœ… æ¨é€åˆ°ä¸»åˆ†æ”¯
- âœ… åˆ›å»ºPull Request
- âœ… æ¯æ—¥å®šæ—¶æ„å»º

å‚è§ `.github/workflows/ci.yml` äº†è§£CIé…ç½®ã€‚

## æµ‹è¯•ç»“æ„

```
tests/
â”œâ”€â”€ unit/                          # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ models/                    # æ¨¡å‹æµ‹è¯•
â”‚   â”‚   â””â”€â”€ device_test.rs        # è®¾å¤‡æ¨¡å‹
â”‚   â””â”€â”€ security/                  # å®‰å…¨æ¨¡å—æµ‹è¯•
â”‚       â””â”€â”€ dukpt_test.rs         # DUKPTåŠ å¯†
â”œâ”€â”€ integration/                   # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ api/                       # APIæµ‹è¯•
â”‚   â”‚   â””â”€â”€ device_api_test.rs    # è®¾å¤‡API
â”‚   â””â”€â”€ services/                  # æœåŠ¡æµ‹è¯•
â”‚       â””â”€â”€ transaction_service_test.rs  # äº¤æ˜“æœåŠ¡
â”œâ”€â”€ lib.rs                         # æµ‹è¯•åº“æ ¹
â”œâ”€â”€ README.md                      # æµ‹è¯•æ–‡æ¡£
â””â”€â”€ run-tests.sh                   # æµ‹è¯•è¿è¡Œè„šæœ¬
```

## ä¸‹ä¸€æ­¥

### æ‰©å±•æµ‹è¯•è¦†ç›–

å¯ä»¥ç»§ç»­æ·»åŠ ä»¥ä¸‹æµ‹è¯•ï¼š

1. **æ›´å¤šå•å…ƒæµ‹è¯•**
   - `tests/unit/models/transaction_test.rs` - äº¤æ˜“æ¨¡å‹æµ‹è¯•
   - `tests/unit/models/threat_test.rs` - å¨èƒæ¨¡å‹æµ‹è¯•
   - `tests/unit/security/jwt_test.rs` - JWTæµ‹è¯•
   - `tests/unit/security/crypto_test.rs` - åŠ å¯†å·¥å…·æµ‹è¯•

2. **æ›´å¤šé›†æˆæµ‹è¯•**
   - `tests/integration/api/transaction_api_test.rs` - äº¤æ˜“APIæµ‹è¯•
   - `tests/integration/api/auth_api_test.rs` - è®¤è¯APIæµ‹è¯•
   - `tests/integration/services/device_service_test.rs` - è®¾å¤‡æœåŠ¡æµ‹è¯•
   - `tests/integration/services/threat_detection_test.rs` - å¨èƒæ£€æµ‹æµ‹è¯•

3. **æ€§èƒ½æµ‹è¯•**
   - è´Ÿè½½æµ‹è¯•
   - å‹åŠ›æµ‹è¯•
   - å¹¶å‘æµ‹è¯•

4. **ç«¯åˆ°ç«¯æµ‹è¯•**
   - å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
   - ç”¨æˆ·åœºæ™¯æµ‹è¯•

## æ•…éšœæ’é™¤

### æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥PostgreSQLçŠ¶æ€
pg_isready

# éªŒè¯è¿æ¥å­—ç¬¦ä¸²
psql $TEST_DATABASE_URL
```

### æµ‹è¯•å¤±è´¥
```bash
# è¯¦ç»†è¾“å‡º
cargo test -- --nocapture

# å•çº¿ç¨‹è¿è¡Œ
cargo test -- --test-threads=1

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_name -- --exact
```

### æ¸…ç†æµ‹è¯•æ•°æ®
```bash
./run-tests.sh clean
```

## æ€»ç»“

âœ… **å·²åˆ›å»º**ï¼š
- 4ä¸ªæµ‹è¯•ç¤ºä¾‹æ–‡ä»¶ï¼ˆ2ä¸ªå•å…ƒæµ‹è¯• + 2ä¸ªé›†æˆæµ‹è¯•ï¼‰
- å®Œæ•´çš„æµ‹è¯•åŸºç¡€è®¾æ–½
- è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£

âœ… **æµ‹è¯•è¦†ç›–**ï¼š
- æ¨¡å‹å±‚ï¼ˆDeviceï¼‰
- å®‰å…¨å±‚ï¼ˆDUKPTï¼‰
- APIå±‚ï¼ˆDevice APIï¼‰
- æœåŠ¡å±‚ï¼ˆTransaction Serviceï¼‰

âœ… **å·¥å…·æ”¯æŒ**ï¼š
- è‡ªåŠ¨åŒ–æµ‹è¯•è¿è¡Œ
- æµ‹è¯•è¦†ç›–ç‡ç”Ÿæˆ
- ç›‘è§†æ¨¡å¼
- CI/CDé›†æˆ

è¿™äº›æµ‹è¯•ç¤ºä¾‹ä¸ºé¡¹ç›®æä¾›äº†åšå®çš„æµ‹è¯•åŸºç¡€ï¼Œå¯ä»¥ä½œä¸ºæ¨¡æ¿ç»§ç»­æ‰©å±•å…¶ä»–æ¨¡å—çš„æµ‹è¯•ã€‚
